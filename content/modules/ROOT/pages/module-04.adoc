= Lab Guide: Generating and Responding to Events
:doctype: book
:notoc:
:toc-title: Table of Contents
:nosectnums:
:icons: font

_A guide to using Prometheus to generate an alert and Event-Driven Ansible to automatically remediate the issue._

---

== Introduction: Automation and Observability

Event-Driven Ansible is a fantastic way to bridge the gap between observability and automation. In many organizations, the teams that oversee observability platforms are not the same teams that orchestrate automation. Event-Driven Ansible allows you to use events generated by observability platforms like Prometheus to influence and trigger your automated workflows.

In this example, you'll use Prometheus to monitor two RHEL nodes. When an alert is triggered, Alertmanager will send the event to Ansible Automation Platform, where your rulebook activation is waiting to act.

[NOTE]
====
**Prometheus** is an open-source monitoring system that collects and analyzes metrics from applications and infrastructure.

**Alertmanager** is a Prometheus component that handles alerts. It is responsible for deduplicating, grouping, and routing them to the correct receiver, such as email, PagerDuty, or in this case, Event-Driven Ansible.
====

[IMPORTANT]
====
.Environment Credentials
====
.Ansible Automation Platform (AAP)
* **Username:** `admin`
* **Password:** `ansible123!`

.Gitea
* **Username:** `student`
* **Password:** `learn_ansible`
====

---

== Task: Triggering and Remediating an SELinux Alert

You will now walk through the entire event-driven workflow: examining an alert in Prometheus, triggering it by disabling SELinux, and observing the automated remediation.

.   **Explore the Prometheus alert.** Navigate to the link:tab-2[Prometheus] tab. At the top, click **Alerts**. You will see a single alert configured called "selinux disabled." **Expand** this alert by clicking the small arrow to its left.
+
image::image.png[Prometheus Alerts tab, opts="border"]
+
The line starting with `expr` is the condition that Prometheus is evaluating. It means, "trigger an alert when the metric `node_selinux_current_mode` is equal to `0` (disabled)." If you click the `expr` link, you will be taken to the Graph page, which will show an "Empty query result" because SELinux is currently enabled on both nodes.

.   **Disable SELinux on a RHEL node.** Go to either the link:tab-3[RHEL 1] tab or the link:tab-4[RHEL 2] tab and **run** the following commands:
+
[source,bash]
----
sudo getenforce
sudo setenforce 0
sudo getenforce
----
+
The output should show that the status has changed from "Enforcing" to "Permissive."
+
[source,text]
----
[rhel@rhel-1 ~]$ sudo getenforce
Enforcing
[rhel@rhel-1 ~]$ sudo setenforce 0
[rhel@rhel-1 ~]$ sudo getenforce
Permissive
----

.   **Observe the active alert in Prometheus.** Return to the link:tab-2[Prometheus] tab and click **Alerts**. The "selinux disabled" rule should now show "(1 active)". If it doesn't, wait a few seconds and refresh the page. When you expand the rule, the state will show as "PENDING" and then transition to "FIRING." Once it is "FIRING," the event is sent to Ansible Automation Platform.
+
image::image.png[SELinux alert firing in Prometheus, opts="border"]

.   **Observe the Rule Audit in AAP.** It may take a minute or two for the alert to fire. Once it does, go to the link:tab-0[AAP] tab and navigate to **Automation Decisions** â†’ **Rule Audit**. You will find a new entry named "SELinux was disabled (firing)". **Click** on it to view the event payload in the *Events* tab and the job that was run in the *Actions* tab.
+
image::image.png[Rule Audit showing the SELinux event and action, opts="border"]

.   **Observe the automated remediation job.** In the `AAP` tab, navigate to **Automation Execution** â†’ **Jobs**. You will see a new job called "Apply baseline." This job template was triggered by the event and will re-enable SELinux. **Click** the job to view its details. Notice in the *Details* tab that a **Limit** was applied to the job.
+
image::image.png[Job Details showing a limit applied to the host, opts="border"]
+
The running rulebook extracted the hostname from the event payload and used that value to limit the playbook execution to only the node where SELinux was disabled.

.   **Verify the fix.** Go back to the RHEL node where you disabled SELinux and **run** the following command:
+
[source,bash]
----
sudo getenforce
----
+
The output should now be "Enforcing."

.   **Review the resolved event.** Because SELinux was re-enabled, the alert in Prometheus will clear. When this happens, Alertmanager sends a "resolved" event to AAP. The Rule Audit page will now show both the "firing" and the "resolved" events.
+
image::Nov-12-2024_at_14.43.58-image.png[Rule Audit showing both firing and resolved events, opts="border"]

---

== Review

To review, someone disabled SELinux, Prometheus detected this and fired an alert, and Event-Driven Ansible automatically caught the event and ran a playbook to fix it. This entire process happened without any manual intervention.

== Next Steps

Moving right along to the next challenge then! ðŸ‘‰

== Troubleshooting

If you have encountered an issue with this lab, please link:https://github.com/ansible/instruqt/issues/new?labels=eda-up-and-running-25&title=New+EDA+issue:+generate-events+(Sandbox+id:+[[ Instruqt-Var key="SANDBOX" hostname="aap" ]])&assignees=cloin[open an issue on GitHub].
